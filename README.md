# Пропускная система

## Используемые технологии:

![My Skills](https://skillicons.dev/icons?i=nodejs,nestjs,mongodb,angular,docker)

## Описание проекта

Это проект для управления пропусками в здание с поддержкой **реального времени**. Он включает:

- **Пользовательский интерфейс** (фронтенд), где пользователи могут подать заявку на пропуск.
- **Административный интерфейс**, где администраторы могут просматривать и изменять статусы заявок.
- **Бэкенд**, реализованный на NestJS, использующий **Server-Sent Events (SSE)** для отправки обновлений в реальном времени.
- **База данных** - MongoDb для хранения всей информации (о пользователях и их заявках)
- **MongoDB Replica Set**, используемый для реактивных обновлений через Change Streams.
- **Docker** для автоматизации поднятия базы данных MongoDB

**Базовая структура проекта:**

<pre>
├── backend             # Серверная часть на NestJS
├── frontend            # Пользовательский интерфейс (создание пропусков)
├── frontend-admin      # Админская панель (изменение статусов)
└── .nvmrc              # Указание версии Node.js
</pre>

## Версия Node.js

Версия Node.js указана в файле `.nvmrc`.  
Рекомендуется использовать [nvm (для UNIX систем)](https://github.com/nvm-sh/nvm) или [nvm-windows](https://github.com/coreybutler/nvm-windows) для автоматического переключения версий.

---

## Как запускать

1. Установить переменные окружения:

	```bash
	npm run create-env
	```

2. Убедитесь, что установлен и запущен [Docker Desktop](https://www.docker.com/products/docker-desktop)

3. Запустить контейнеры:

	```bash
	npm run docker
	```
	Подождите, пока все образы и контейнеры будут запущены.

4. Интерфейсы по умолчанию доступны по адресам:

   - Пользовательский фронтенд (создание пропусков): [http://localhost:4700/](http://localhost:4700/)  
   - Админский фронтенд (обработка заявок): [http://localhost:4600/](http://localhost:4600/)

## Запуск в режиме разработки:

1. Запустить `npm install`
2. Запустить `npm run docker:db`

Выборочно запустить:

- `npm run start` - бекенд и два фронта
- `npm run start:backend` - бекенд
- `npm run start:frontend` - фронтенд для пользователей
- `npm run start:frontend-admin` - фронтенд для админов
	 
## Автоматизация

Для обеспечения поддержки **реактивных обновлений через Change Streams** используется MongoDB в режиме **Replica Set**. Весь процесс полностью автоматизирован с использованием Docker и shell-скрипта `docker-entrypoint.sh`.

Что делает автоматизация:

- При первом запуске контейнера инициализируется **Replica Set**.
- Генерируется **keyfile** для защищённой репликации между узлами.
- Ожидается поднятие MongoDB, затем проверяется состояние Replica Set.
- При необходимости вызывается `rs.initiate()` с корректным конфигом.
- Создаётся администратор MongoDB, если он ещё не существует.
- После инициализации происходит остановка и перезапуск MongoDB с включённой авторизацией (`--auth`) и указанным `--keyFile`, так как это требует MongoDB в режиме Replica Set

Все переменные (порты, логины, пароли, имя реплики и т.д.) конфигурируются через `.env` файл и автоматически подставляются при старте контейнера.

> Скрипт `docker-entrypoint.sh` монтируется в контейнер и выполняется как точка входа (`entrypoint`) для MongoDB.
